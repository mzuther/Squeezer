\chapter{Build process}
\label{chap:build_process}

\section{Dependencies}
\label{sec:dependencies}

\subsection{premake}
\label{sec:dependencies_premake}

\begin{tabbing}
  \hspace*{6em}\=\=\kill

  Importance:  \> required \\
  Version:     \> 5.0.0 (beta2) \\
  License:     \> BSD \\
  Homepage:    \> \href{https://premake.github.io/}{premake.github.io}
\end{tabbing}

\subsubsection{Installation}

Place the binary somewhere in your \path{PATH}.  Depending on your
platform, you should run \path{premake} using the scripts
\path{Builds/render_templates.sh} or
\path{Builds/render_templates.bat}.

To change the premake file using Jinja templates, you'll also have to
install the necessary dependencies.

\subsection{Compilers}

\begin{tabbing}
  \hspace*{6em}\=\=\kill

  Importance:  \> required \\
  Linux:       \> Clang 14.0 (or gcc 11.2.0) \\
  Windows:     \> Visual Studio 2019 (and above) \\
  License:     \> proprietary (Visual Studio) / Open Source \\
\end{tabbing}

Use premake (\ref{sec:dependencies_premake}) to generate the Make
files (or project) files needed by different compilers.

\emph{Different compiler versions may work, and premake supports other
  compiler tool sets as well.  But in this case, you're on your own!}

\subsection{JUCE library}

\begin{tabbing}
  \hspace*{6em}\=\=\kill

  Importance:  \> required \\
  Version:     \> 6.0.5 \\
  License:     \> ISC and GPL v3 (among others) \\
  Homepage:    \> \href{http://www.juce.com/}{www.juce.com}
\end{tabbing}

\subsubsection{Installation}

Extract the archive into the directory \path{libraries/juce}.

\subsection{Virtual Studio Technology SDK}

\begin{tabbing}
  \hspace*{6em}\=\=\kill

  Importance:  \> optional \\
  Version:     \> 2.4 \\
  License:     \> proprietary \\
  Homepage:    \> \href{http://www.steinberg.net/en/company/developer.html}{www.steinberg.net}
\end{tabbing}

\subsubsection{Installation}

\emph{The VST3 SDK is now open source and included in JUCE.}

For VST2 SDK, extract the archive into the directories
\path{libraries/vst2}.  The proprietary VST2 SDK is not available
anymore and you may only distribute VST2 plug-ins if you have signed
the old license agreement!

\subsection{Python}

\begin{tabbing}
  \hspace*{6em}\=\=\kill

  Importance:  \> optional \\
  Version:     \> 3.10 (or higher) \\
  License:     \> Python Software Foundation License \\
  Homepage:    \> \href{http://www.python.org/}{www.python.org}
\end{tabbing}

You'll only need Python if you want to auto-generate files from Jinja
templates.

\subsubsection{Installation (Windows)}

You can download an installer from the website.

\subsection{Jinja}

\begin{tabbing}
  \hspace*{6em}\=\=\kill

  Importance:  \> optional \\
  Version:     \> 3.0.3 (or higher) \\
  License:     \> BSD \\
  Homepage:    \> \href{http://jinja.pocoo.org/}{jinja.pocoo.org}
\end{tabbing}

You'll only need Jinja if you want to auto-generate files such as the
premake file from templates (see \ref{sec:dependencies_premake}).

\subsection{Artistic Style}

\begin{tabbing}
  \hspace*{6em}\=\=\kill

  Importance:  \> optional \\
  Version:     \> 3.1 \\
  License:     \> LGPL v3 \\
  Homepage:    \> \href{http://astyle.sourceforge.net/}{astyle.sourceforge.net}
\end{tabbing}

This application formats the code so it looks more beautiful and
consistent.  Thus, you only have to install it if you plan to help me
with coding.

\subsubsection{Installation}

Place the binary somewhere in your \path{PATH}.  Depending on your
platform, you should run \path{astyle} using the scripts
\path{Source/format_code.sh} or \path{Source/format_code.bat}.

\subsection{googletest}

\begin{tabbing}
  \hspace*{6em}\=\=\kill

  Importance:  \> optional \\
  Version:     \> 1.10.0 \\
  License:     \> BSD 3-clauses \\
  Homepage:    \> \href{https://github.com/google/googletest}{github.com/google/googletest}
\end{tabbing}

This is a framework for testing and mocking.  You only need to install
it if you plan to help me with coding.

\subsubsection{Installation on GNU/Linux}

Extract the archive into the directory \path{libraries/googletest},
change into this directory and run:

\begin{VerbatimBoth}
  mkdir googletest/build
  cd googletest/build
\end{VerbatimBoth}

\begin{Verbatim64}
  rm -f ./CMakeCache.txt
  cmake ..
  make
  mkdir -p lib/linux/amd64/
  mv lib/*.a lib/linux/amd64/
  make clean
\end{Verbatim64}

\section{General preparation}
\label{sec:general_preparation}

Copy \path{Source/build_id-COPY.h} to \path{Source/build_id.h}.

Edit the copied file to add a custom build ID to the "About" dialog.
Or set up Git hooks that update the file for you.

\newpage %% layout

\section{GNU/Linux}

\subsection{Environment}

\emph{Supporting 32-bit Linux has become very tedious in the last
  years, so I have officially dropped it.  But it should be easy to
  adapt these instructions to 32-bit systems.}

To build this application yourself, I recommend setting up a
\texttt{chroot} environment.  This is fast and easy to do on
Debian-based systems and might save you a \textbf{lot} of trouble.  At
the time of writing, I'm using Linux Mint 20, but the procedure should
be similar on your distribution of choice.

Start by installing the necessary packages:

\begin{VerbatimBoth}
  sudo apt install debootstrap schroot
\end{VerbatimBoth}

Then install the \texttt{chroot} base system by executing the
following statements:

\begin{Verbatim64}
  sudo debootstrap --variant=buildd \
    --arch amd64 jammy \
    /srv/chroot/jammy_amd64 \
    http://archive.ubuntu.com/ubuntu
\end{Verbatim64}

Running \path{debootstrap} will take some time.  Meanwhile, add the
following lines to \path{/etc/schroot/schroot.conf} (make sure you
remove all preceding white space so that each line begins in the first
column):

\begin{Verbatim64}
  [jammy-amd64]
  description=Ubuntu jammy (amd64)
  directory=/srv/chroot/jammy_amd64
  profile=default
  personality=linux
  type=directory
  users=username
\end{Verbatim64}

Please make the necessary changes to \texttt{username}.  If you
experience problems, you can try to change \texttt{jammy} to an older
Ubuntu release, or to a Debian release such as \texttt{bullseye}.

When \path{debootstrap} is done, log in as superuser:

\begin{Verbatim64}
  sudo schroot -c jammy-amd64
\end{Verbatim64}

First, install a few packages -- these are optional, but might come in
handy:

\begin{VerbatimBoth}
  apt update
  apt -y install bash-completion less nano vim
\end{VerbatimBoth}

Then, use \path{nano} or \path{vim} to change a line in
\path{/etc/apt/sources.list} (please ignore the line break, it should
be a single line):

\begin{VerbatimBoth}
  deb http://archive.ubuntu.com/ubuntu jammy
  main restricted universe
\end{VerbatimBoth}

Now install the remaining packages:

\begin{VerbatimBoth}
  apt update
  apt -y install clang cmake mc libasound2-dev \
    libjack-jackd2-dev libpthread-workqueue-dev \
    mesa-common-dev xorg-dev
  apt clean
\end{VerbatimBoth}

If you like \path{bash} completion, you might also want to open the
file \path{/etc/bash.bashrc} and unquote these lines:

\begin{VerbatimBoth}
  # enable bash completion in interactive shells
  if [...]
    [a couple of lines...]
  fi
\end{VerbatimBoth}

Finally, log out and log in as normal user:

\begin{Verbatim64}
  schroot -c jammy-amd64
\end{Verbatim64}

In this \path{chroot} shell, install the dependencies
(\ref{sec:dependencies}).  Congratulations -- you are now ready to
build!

\newpage %% layout

\subsection{Build}

After preparing the dependencies, start your \texttt{chroot}
environment

\begin{Verbatim64}
  schroot -c jammy-amd64
\end{Verbatim64}

change into the directory \path{Builds} and execute

\begin{VerbatimBoth}
  ./render_templates.sh
  make config=CFG TARGET
\end{VerbatimBoth}

where \application{CFG} is \application{debug\_x64}, or
\application{release\_x64}, and \application{TARGET} is the version
you want to compile, such as \application{linux\_standalone\_stereo}.

In case you run into problems, you can try to switch compilers by
opening the file \texttt{run\_premake.sh} and using the premake
options \texttt{--cc=clang} or \texttt{--cc=gcc}.

The compiled binaries will end up in the directory \path{bin}.

\newpage %% layout

\section{Microsoft Windows}

\subsection{Build}

After setting up the dependencies, open the directory \path{Builds}
and execute

\begin{VerbatimBoth}
  ./render_templates.bat
\end{VerbatimBoth}

Then change into the directory \path{Builds/windows/vs20xx}, open the
project file with the corresponding version of Visual Studio and build
the project.

The compiled binaries will end up in the directory \path{bin}.

%%% Local Variables:
%%% mode: latex
%%% mode: outline-minor
%%% TeX-command-default: "Rubber"
%%% TeX-master: "../squeezer"
%%% TeX-PDF-mode: t
%%% ispell-local-dictionary: "british"
%%% End:
